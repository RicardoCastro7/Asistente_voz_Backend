<!doctype html>
<html lang="es">

<head>

  <meta charset="utf-8" />
  <title>Gestor de Informaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- ‚≠ê Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
</head>

<body>
  <header class="topbar">
    <img src="{{ url_for('imagenes', filename='logo_computacion.png') }}" class="topbar-logo">
    <div class="topbar-text">
      <h1>UNIVERSIDAD NACIONAL DE LOJA</h1>
      <p>Carrera de computaci√≥n</p>
    </div>
  </header>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">Computaci√≥n Aplicada</div>
        <div class="sidebar-pill"></div>
      </div>

      <nav class="sidebar-menu">
        <p class="sidebar-section-title">Principal</p>
        <button class="sidebar-item active" data-section="dashboard">
          <span class="sidebar-icon">üè†</span>
          <span class="sidebar-label">Dashboard</span>
        </button>

        <button class="sidebar-item" data-section="files">
          <span class="sidebar-icon">üìÅ</span>
          <span class="sidebar-label">Mis Archivos</span>
        </button>

        <button class="sidebar-item" data-section="upload">
          <span class="sidebar-icon">‚¨ÜÔ∏è</span>
          <span class="sidebar-label">Subir Documentos</span>
        </button>

        <button class="sidebar-item disabled">
          <span class="sidebar-icon">üîç</span>
          <span class="sidebar-label">B√∫squeda Avanzada</span>
          <span class="sidebar-badge">Pr√≥ximamente</span>
        </button>

        <p class="sidebar-section-title">Herramientas</p>
        <button class="sidebar-item" data-section="voice">
          <span class="sidebar-icon">üß†</span>
          <span class="sidebar-label">Asistente de Voz</span>
        </button>

        <button class="sidebar-item" data-section="faq">
          <span class="sidebar-icon">‚ùì</span>
          <span class="sidebar-label">Preguntas Frecuentes</span>
        </button>

        <p class="sidebar-section-title">Sistema</p>
        <button class="sidebar-item" data-section="config">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span class="sidebar-label">Configuraci√≥n</span>
        </button>
        <button class="sidebar-item disabled">
          <span class="sidebar-icon">üí¨</span>
          <span class="sidebar-label">Ayuda</span>
        </button>

        {% if es_admin %}
        <p class="sidebar-section-title">Administraci√≥n</p>
        <button class="sidebar-item" data-section="users">
          <span class="sidebar-icon">üßë‚Äçüíª</span>
          <span class="sidebar-label">Gesti√≥n de usuarios</span>
        </button>
        {% endif %}
      </nav>

      <div class="sidebar-user">
        <div class="sidebar-avatar">{{ username[:1] | upper }}</div>
        <div class="sidebar-user-info">
          <span class="sidebar-user-name">{{ username }}</span>
          <span class="sidebar-user-role">Administrador</span>
        </div>
        <a href="{{ url_for('logout') }}" class="sidebar-logout">Cerrar sesi√≥n</a>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="content">
      <!-- DASHBOARD -->
      <section id="section-dashboard" class="card section active">

        <h2 style="margin-bottom:0.8rem;">Panel General del Sistema üéì</h2>
        <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:1.5rem;">
          Bienvenido, {{ username }}. Aqu√≠ puedes visualizar el estado general del asistente acad√©mico y
          documentos institucionales.
        </p>

        <!-- Tarjetas informativas -->
        <div style="display:flex; gap:1rem; flex-wrap:wrap;">

          <div
            style="flex:1; min-width:220px; background:#0f172a; padding:1rem; border-radius:0.8rem; border:1px solid rgba(148,163,184,0.2);">
            <h3 style="margin:0; font-size:0.95rem; color:#a5b4fc;">üìÑ Documentos cargados</h3>
            <p style="font-size:1.8rem; margin:0.4rem 0; color:#f8fafc;">{{ files|length }}</p>
            <p style="font-size:0.8rem; color:#94a3b8;">PDFs en la base de conocimiento</p>
          </div>

          <div
            style="flex:1; min-width:220px; background:#0f172a; padding:1rem; border-radius:0.8rem; border:1px solid rgba(148,163,184,0.2);">
            <h3 style="margin:0; font-size:0.95rem; color:#a5b4fc;">üß† Prompt activo</h3>
            <p style="font-size:1.1rem; margin:0.55rem 0; color:#f8fafc;">
              {% if prompts %}{{ prompts[0].nombre }}{% else %}Sin configurar{% endif %}
            </p>
            <p style="font-size:0.8rem; color:#94a3b8;">Configuraci√≥n actual del asistente</p>
          </div>

          {% if es_admin %}
          <div
            style="flex:1; min-width:220px; background:#0f172a; padding:1rem; border-radius:0.8rem; border:1px solid rgba(148,163,184,0.2);">
            <h3 style="margin:0; font-size:0.95rem; color:#a5b4fc;">üë• Usuarios pendientes</h3>
            <p style="font-size:1.8rem; margin:0.4rem 0; color:#f8fafc;">{{ pending_users_count }}</p>
            <p style="font-size:0.8rem; color:#94a3b8;">Cuentas esperando aprobaci√≥n</p>
          </div>
          {% endif %}

        </div>

        <!-- L√≠nea divisoria -->
        <div style="height:1px; background:rgba(148,163,184,0.2); margin:1.5rem 0;"></div>

        <!-- Gr√°ficos -->
        <div style="display:flex; flex-wrap:wrap; gap:1.2rem;">

          <!-- Consultas por d√≠a -->
          <div
            style="flex:2; min-width:280px; background:#020617; border-radius:0.9rem; padding:1rem 1.2rem; border:1px solid rgba(148,163,184,0.3);">
            <h3 style="margin-top:0; font-size:0.95rem; color:#e5e7eb;">üìà Consultas al asistente (por d√≠a)</h3>
            <canvas id="chartConsultas" style="margin-top:0.6rem;"></canvas>
          </div>

          <!-- Usuarios activos vs pendientes -->
          <div
            style="flex:1; min-width:260px; background:#020617; border-radius:0.9rem; padding:1rem 1.2rem; border:1px solid rgba(148,163,184,0.3);">
            <h3 style="margin-top:0; font-size:0.95rem; color:#e5e7eb;">üë§ Estado de usuarios</h3>
            <canvas id="chartUsuarios" style="margin-top:0.6rem;"></canvas>
          </div>

        </div>

        <!-- Descripci√≥n t√©cnica del proyecto -->
        <div style="height:1px; background:rgba(148,163,184,0.2); margin:1.5rem 0;"></div>

        <h3 style="color:#a5b4fc; margin-bottom:0.3rem;">¬øC√≥mo funciona el asistente?</h3>
        <p style="color:#94a3b8; font-size:0.85rem; line-height:1.5;">
          Este sistema implementa una arquitectura <strong>RAG (Retrieval Augmented Generation)</strong> que permite
          responder preguntas basadas en documentos institucionales de la UNL.
          Los PDFs se procesan mediante <strong>chunking</strong>, se convierten en <strong>embeddings
            sem√°nticos</strong> usando el modelo <strong>BGE-M3</strong>,
          y se almacenan en <strong>ChromaDB</strong>. Cuando realizas una consulta, el asistente recupera los
          fragmentos m√°s relevantes y genera una respuesta
          contextualizada usando el modelo <strong>Gemini 2.5 Flash Lite</strong>.
        </p>

        <div
          style="margin-top:1rem; padding:1rem; border-radius:0.8rem; background:rgba(15,23,42,0.65); border:1px solid rgba(148,163,184,0.25);">
          <pre style="margin:0; font-size:0.85rem; color:#e2e8f0;">
            PDF ‚îÄ‚îÄ> Chunking ‚îÄ‚îÄ> Embeddings (BGE-M3) ‚îÄ‚îÄ> ChromaDB ‚îÄ‚îÄ> Gemini RAG ‚îÄ‚îÄ> Respuesta inteligente
          </pre>
        </div>

      </section>

      <!-- PREGUNTAS FRECUENTES / HISTORIAL -->
      <section id="section-faq" class="card section">
        <h2>Preguntas Frecuentes</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Historial de consultas realizadas al asistente. Se registra la pregunta y la fecha en que fue enviada.
        </p>

        {% if preguntas %}
        <div style="margin-top:1rem; max-height:420px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
            <thead>
              <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                <th style="text-align:left; padding:0.4rem 0.3rem; white-space:nowrap;">Fecha</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Pregunta</th>
              </tr>
            </thead>
            <tbody>
              {% for p in preguntas %}
              <tr style="border-bottom:1px solid rgba(30,41,59,0.6);">
                <td style="padding:0.35rem 0.3rem; color:#94a3b8; font-size:0.8rem; white-space:nowrap;">
                  {{ p.fecha_creacion }}
                </td>
                <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                  {{ p.texto }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty">
          <div class="empty-icon">‚ùì</div>
          <p>A√∫n no hay preguntas registradas.</p>
          <p class="muted">Cuando el asistente reciba consultas, aparecer√°n aqu√≠.</p>
        </div>
        {% endif %}
      </section>

      <!-- SUBIR DOCUMENTOS -->
      <section id="section-upload" class="card section">
        <h2>Subir Archivos</h2>
        <div id="dropzone" class="dropzone">
          <div class="icon">üìÑ</div>
          <p>Arrastra archivos PDF aqu√≠</p>
          <button id="btnSelect" class="btn-primary">Seleccionar archivos</button>
          <input type="file" id="fileInput" accept="application/pdf" style="display:none">
        </div>

        <div class="stats">
          <p><strong>Total de archivos:</strong> {{ files|length }}</p>
          <p><strong>Tama√±o total:</strong> {{ '%.2f' % (total_size / (1024*1024)) }} MB</p>
        </div>
      </section>

      <!-- MIS ARCHIVOS -->
      <section id="section-files" class="card section">
        <h2>Archivos Subidos</h2>
        {% if files %}
        <ul class="file-list" id="fileList">
          {% for f in files %}
          <li data-name="{{ f }}">
            <span class="file-icon">üìÑ</span>
            <a href="{{ url_for('serve_file', filename=f) }}" target="_blank">{{ f }}</a>
            <button class="btn-delete" data-name="{{ f }}">Eliminar</button>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="empty">
          <div class="empty-icon">üìÑ</div>
          <p>No hay archivos subidos</p>
          <p class="muted">Sube algunos archivos para comenzar</p>
        </div>
        {% endif %}
      </section>
      <!-- CONFIGURACI√ìN: GESTI√ìN DE PROMPTS -->
      <section id="section-config" class="card section">
        <h2>Configuraci√≥n del asistente</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Aqu√≠ puedes gestionar los <strong>pro mpts</strong> del asistente: crear nuevos, editarlos,
          eliminarlos y elegir cu√°l estar√° activo.
        </p>

        <!-- Crear nuevo prompt -->
        <div style="margin-top:1rem; padding:1rem; border-radius:0.75rem; background:rgba(15,23,42,0.8);">
          <h3 style="margin-top:0; font-size:1rem;">Crear nuevo prompt</h3>

          <form method="post" action="{{ url_for('create_prompt') }}">
            <div style="margin-bottom:0.5rem;">
              <label style="display:block; font-size:0.85rem; color:#94a3b8; margin-bottom:0.2rem;">
                Nombre del prompt
              </label>
              <input type="text" name="nombre" required
                style="width:100%; padding:0.45rem 0.6rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.9rem;">
            </div>

            <div style="margin-bottom:0.5rem;">
              <label style="display:block; font-size:0.85rem; color:#94a3b8; margin-bottom:0.2rem;">
                Contenido del prompt
              </label>
              <textarea name="contenido" rows="7" required
                style="width:100%; padding:0.6rem 0.7rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.9rem; resize:vertical;"></textarea>
            </div>

            <label style="font-size:0.85rem; color:#94a3b8;">
              <input type="checkbox" name="activar" style="margin-right:0.3rem;">
              Establecer como prompt activo
            </label>

            <div style="margin-top:0.7rem;">
              <button type="submit" class="btn-primary">
                Guardar prompt
              </button>
            </div>
          </form>
        </div>

        <!-- Lista de prompts existentes -->
        <h3 style="margin-top:1.4rem; font-size:1rem;">Prompts configurados</h3>

        {% if prompts %}
        <div style="margin-top:0.5rem; max-height:360px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
            <thead>
              <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                <th style="text-align:left; padding:0.4rem 0.3rem;">Nombre</th>
                <th style="text-align:left; padding:0.4rem 0.3rem; width:45%;">Contenido</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Estado</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pr in prompts %}
              <tr style="border-bottom:1px solid rgba(30,41,59,0.6); vertical-align:top;">
                <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                  {{ pr.nombre }}
                  <div style="font-size:0.75rem; color:#64748b;">
                    {{ pr.created_at }}
                  </div>
                </td>
                <td style="padding:0.35rem 0.3rem; color:#cbd5f5; font-size:0.85rem; white-space:pre-wrap;">
                  {{ pr.contenido[:260] }}{% if pr.contenido|length > 260 %}...{% endif %}
                </td>
                <td style="padding:0.35rem 0.3rem;">
                  {% if pr.is_active %}
                  <span
                    style="font-size:0.8rem; padding:0.15rem 0.55rem; border-radius:999px; background:rgba(34,197,94,0.15); color:#4ade80;">
                    Activo
                  </span>
                  {% else %}
                  <span
                    style="font-size:0.8rem; padding:0.15rem 0.55rem; border-radius:999px; background:rgba(148,163,184,0.15); color:#94a3b8;">
                    Inactivo
                  </span>
                  {% endif %}
                </td>
                <td style="padding:0.35rem 0.3rem;">
                  <!-- Activar -->
                  {% if not pr.is_active %}
                  <form method="post" action="{{ url_for('activate_prompt', prompt_id=pr.id) }}"
                    style="display:inline;">
                    <button type="submit" class="btn-secondary" style="margin-bottom:0.3rem;">
                      Usar este
                    </button>
                  </form>
                  {% endif %}

                  <!-- Editar (form inline) -->
                  <details style="margin-top:0.2rem;">
                    <summary style="cursor:pointer; font-size:0.8rem; color:#a5b4fc;">Editar</summary>
                    <div style="margin-top:0.4rem;">
                      <form method="post" action="{{ url_for('update_prompt', prompt_id=pr.id) }}">
                        <input type="text" name="nombre" value="{{ pr.nombre }}" required
                          style="width:100%; padding:0.35rem 0.5rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.85rem; margin-bottom:0.35rem;">
                        <textarea name="contenido" rows="5" required
                          style="width:100%; padding:0.45rem 0.6rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.85rem; resize:vertical;">{{ pr.contenido }}</textarea>
                        <div style="margin-top:0.4rem;">
                          <button type="submit" class="btn-primary" style="font-size:0.8rem;">
                            Guardar cambios
                          </button>
                        </div>
                      </form>
                    </div>
                  </details>

                  <!-- Eliminar -->
                  <form method="post" action="{{ url_for('delete_prompt', prompt_id=pr.id) }}"
                    class="form-delete-prompt" style="display:inline-block; margin-top:0.3rem;">
                    <button type="submit"
                      style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; border-radius:0.4rem; padding:0.2rem 0.6rem; font-size:0.8rem; cursor:pointer;">
                      Eliminar
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p style="margin-top:0.8rem; color:#94a3b8; font-size:0.9rem;">
          A√∫n no tienes prompts definidos. Crea uno nuevo en el formulario superior.
        </p>
        {% endif %}
      </section>
      <!-- ASISTENTE DE VOZ -->
      <section id="section-voice" class="card section">
        <div class="voice-card-header">
          <div class="voice-avatar">
            <span>‚ö°</span>
          </div>
          <div class="voice-header-text">
            <h2>UNL Asiste</h2>
            <p><span class="status-dot"></span> Conectado y listo para ayudarte</p>
          </div>
          <div class="voice-header-actions">
            <button class="icon-btn" title="Marcar como favorito">‚≠ê</button>
            <button class="icon-btn" title="Ver detalles">üí¨</button>
          </div>
        </div>

        <div class="voice-body">
          <div id="chatMessages" class="chat-messages">
            <!-- Mensaje inicial del asistente -->
            <div class="msg msg-bot">
              <div class="msg-avatar">ü§ñ</div>
              <div class="msg-bubble">
                <p>¬°Hola! üëã Soy tu asistente acad√©mico. ¬øEn qu√© puedo ayudarte hoy?</p>
              </div>
            </div>
          </div>

          <div class="chat-input-area">
            <div class="chat-hint">Presiona Enter para enviar</div>
            <div class="chat-input-row">
              <input id="chatInput" type="text" placeholder="Escribe tu mensaje aqu√≠..." autocomplete="off" />
              <button id="chatSendBtn" class="chat-send-btn" title="Enviar">
                ‚û§
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- GESTI√ìN DE USUARIOS (solo visible para admin) -->
      <section id="section-users" class="card section">
        <h2>Gesti√≥n de usuarios</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Aqu√≠ puedes aprobar o rechazar las cuentas nuevas registradas en el sistema.
        </p>

        {% if pending_users %}
        <div style="margin-top:1rem; max-height:420px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
            <thead>
              <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                <th style="text-align:left; padding:0.4rem 0.3rem;">Usuario</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Email</th>
                <th style="text-align:left; padding:0.4rem 0.3rem; white-space:nowrap;">Fecha registro</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for u in pending_users %}
              <tr style="border-bottom:1px solid rgba(30,41,59,0.6);">
                <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                  {{ u.username }}
                </td>
                <td style="padding:0.35rem 0.3rem; color:#cbd5f5;">
                  {{ u.email }}
                </td>
                <td style="padding:0.35rem 0.3rem; color:#94a3b8; font-size:0.8rem; white-space:nowrap;">
                  {{ u.created_at }}
                </td>
                <td style="padding:0.35rem 0.3rem;">
                  <!-- Aceptar -->
                  <form method="post" action="{{ url_for('approve_user', user_id=u.id) }}"
                    style="display:inline-block; margin-right:0.3rem;">
                    <button type="submit"
                      style="background:#22c55e; color:#022c22; border:none; border-radius:0.4rem; padding:0.25rem 0.7rem; font-size:0.8rem; cursor:pointer;">
                      Aceptar
                    </button>
                  </form>

                  <!-- Rechazar -->
                  <form method="post" action="{{ url_for('reject_user', user_id=u.id) }}" class="form-reject-user"
                    style="display:inline-block;">
                    <button type="submit"
                      style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; border-radius:0.4rem; padding:0.25rem 0.7rem; font-size:0.8rem; cursor:pointer;">
                      Rechazar
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty">
          <div class="empty-icon">üë•</div>
          <p>No hay usuarios pendientes por aprobar.</p>
          <p class="muted">Los nuevos registros aparecer√°n aqu√≠ para que los revises.</p>
        </div>
        {% endif %}
      </section>
    </main>
  </div>
  <div id="toast" class="toast"></div>

  <!-- Datos para JS en JSON (seguro y limpio) -->
  <script>
    // ====== CHARTS DEL DASHBOARD ======
    const consultasLabels = {{ consultas_labels | default ([]) | tojson | safe }};
    const consultasValues = {{ consultas_values | default ([]) | tojson | safe }};
    const usersLabels = {{ users_labels     | default ([]) | tojson | safe }};
    const usersValues = {{ users_values     | default ([]) | tojson | safe }};

    // Gr√°fico de consultas por d√≠a
    const canvasConsultas = document.getElementById('chartConsultas');
    if (canvasConsultas && consultasLabels.length > 0) {
      const ctx1 = canvasConsultas.getContext('2d');
      new Chart(ctx1, {
        type: 'line',
        data: {
          labels: consultasLabels,
          datasets: [{
            label: 'Consultas',
            data: consultasValues,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(129,140,248,0.25)',
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 3,
            pointBackgroundColor: '#a855f7'
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af' },
              grid: { color: 'rgba(55,65,81,0.4)' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af', precision: 0 },
              grid: { color: 'rgba(31,41,55,0.6)' }
            }
          }
        }
      });
    }

    // Gr√°fico usuarios activos vs pendientes
    const canvasUsers = document.getElementById('chartUsuarios');
    if (canvasUsers && usersLabels.length > 0) {
      const ctx2 = canvasUsers.getContext('2d');
      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: usersLabels,
          datasets: [{
            label: 'Usuarios',
            data: usersValues,
            backgroundColor: [
              'rgba(34,197,94,0.7)',   // activos
              'rgba(248,113,113,0.8)'  // pendientes
            ],
            borderRadius: 6,
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af' },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af', precision: 0 },
              grid: { color: 'rgba(31,41,55,0.6)' }
            }
          }
        }
      });
    }
  </script>
</body>

</html>