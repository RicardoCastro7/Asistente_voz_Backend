<!doctype html>
<html lang="es">
  
<head>
  <meta charset="utf-8" />
  <title>Gestor de Informaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <header class="topbar">
    <h1>UNIVERSIDAD NACIONAL DE LOJA</h1>
    <p>Carrera de computaci√≥n</p>
  </header>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">Computaci√≥n Aplicada</div>
        <div class="sidebar-pill"></div>
      </div>

      <nav class="sidebar-menu">
        <p class="sidebar-section-title">Principal</p>
        <button class="sidebar-item active" data-section="dashboard">
          <span class="sidebar-icon">üè†</span>
          <span class="sidebar-label">Dashboard</span>
        </button>

        <button class="sidebar-item" data-section="files">
          <span class="sidebar-icon">üìÅ</span>
          <span class="sidebar-label">Mis Archivos</span>
        </button>

        <button class="sidebar-item" data-section="upload">
          <span class="sidebar-icon">‚¨ÜÔ∏è</span>
          <span class="sidebar-label">Subir Documentos</span>
        </button>

        <button class="sidebar-item disabled">
          <span class="sidebar-icon">üîç</span>
          <span class="sidebar-label">B√∫squeda Avanzada</span>
          <span class="sidebar-badge">Pr√≥ximamente</span>
        </button>

        <p class="sidebar-section-title">Herramientas</p>
        <button class="sidebar-item" data-section="voice">
          <span class="sidebar-icon">üß†</span>
          <span class="sidebar-label">Asistente de Voz</span>
        </button>

        <button class="sidebar-item" data-section="faq">
          <span class="sidebar-icon">‚ùì</span>
          <span class="sidebar-label">Preguntas Frecuentes</span>
        </button>

        <p class="sidebar-section-title">Sistema</p>
        <button class="sidebar-item" data-section="config">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span class="sidebar-label">Configuraci√≥n</span>
        </button>
        <button class="sidebar-item disabled">
          <span class="sidebar-icon">üí¨</span>
          <span class="sidebar-label">Ayuda</span>
        </button>

        {% if es_admin %}
        <p class="sidebar-section-title">Administraci√≥n</p>
        <button class="sidebar-item" data-section="users">
          <span class="sidebar-icon">üßë‚Äçüíª</span>
          <span class="sidebar-label">Gesti√≥n de usuarios</span>
        </button>
        {% endif %}
      </nav>

      <div class="sidebar-user">
        <div class="sidebar-avatar">{{ username[:1] | upper }}</div>
        <div class="sidebar-user-info">
          <span class="sidebar-user-name">{{ username }}</span>
          <span class="sidebar-user-role">Administrador</span>
        </div>
        <a href="{{ url_for('logout') }}" class="sidebar-logout">Cerrar sesi√≥n</a>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="content">
      <!-- DASHBOARD -->
      <section id="section-dashboard" class="card section active">
        <h2>Bienvenido al Dashboard üëã</h2>
        <p style="margin-top:0.5rem; color:#94a3b8; font-size:0.9rem;">
          Desde aqu√≠ podr√°s gestionar los documentos que alimentan tu asistente de voz y otras herramientas.
        </p>

        <ul style="margin-top:1rem; font-size:0.9rem; color:#e2e8f0;">
          <li><strong>Mis Archivos:</strong> revisa y elimina los PDFs ya cargados.</li>
          <li><strong>Subir Documentos:</strong> arrastra nuevos PDFs para que se indexen en la base de conocimiento.
          </li>
          <li><strong>Integraci√≥n RAG:</strong> los documentos se procesan y se almacenan en ChromaDB para ser usados
            por tu asistente.</li>
        </ul>
      </section>

      <!-- PREGUNTAS FRECUENTES / HISTORIAL -->
      <section id="section-faq" class="card section">
        <h2>Preguntas Frecuentes</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Historial de consultas realizadas al asistente. Se registra la pregunta y la fecha en que fue enviada.
        </p>

        {% if preguntas %}
        <div style="margin-top:1rem; max-height:420px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
            <thead>
              <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                <th style="text-align:left; padding:0.4rem 0.3rem; white-space:nowrap;">Fecha</th>
                <th style="text-align:left; padding:0.4rem 0.3rem;">Pregunta</th>
              </tr>
            </thead>
            <tbody>
              {% for p in preguntas %}
              <tr style="border-bottom:1px solid rgba(30,41,59,0.6);">
                <td style="padding:0.35rem 0.3rem; color:#94a3b8; font-size:0.8rem; white-space:nowrap;">
                  {{ p.fecha_creacion }}
                </td>
                <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                  {{ p.texto }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty">
          <div class="empty-icon">‚ùì</div>
          <p>A√∫n no hay preguntas registradas.</p>
          <p class="muted">Cuando el asistente reciba consultas, aparecer√°n aqu√≠.</p>
        </div>
        {% endif %}
      </section>

      <!-- SUBIR DOCUMENTOS -->
      <section id="section-upload" class="card section">
        <h2>Subir Archivos</h2>
        <div id="dropzone" class="dropzone">
          <div class="icon">üìÑ</div>
          <p>Arrastra archivos PDF aqu√≠</p>
          <button id="btnSelect" class="btn-primary">Seleccionar archivos</button>
          <input type="file" id="fileInput" accept="application/pdf" style="display:none">
        </div>

        <div class="stats">
          <p><strong>Total de archivos:</strong> {{ files|length }}</p>
          <p><strong>Tama√±o total:</strong> {{ '%.2f' % (total_size / (1024*1024)) }} MB</p>
        </div>
      </section>

      <!-- MIS ARCHIVOS -->
      <section id="section-files" class="card section">
        <h2>Archivos Subidos</h2>
        {% if files %}
        <ul class="file-list" id="fileList">
          {% for f in files %}
          <li data-name="{{ f }}">
            <span class="file-icon">üìÑ</span>
            <a href="{{ url_for('serve_file', filename=f) }}" target="_blank">{{ f }}</a>
            <button class="btn-delete" data-name="{{ f }}">Eliminar</button>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="empty">
          <div class="empty-icon">üìÑ</div>
          <p>No hay archivos subidos</p>
          <p class="muted">Sube algunos archivos para comenzar</p>
        </div>
        {% endif %}
      </section>
      <!-- CONFIGURACI√ìN: GESTI√ìN DE PROMPTS -->
      <section id="section-config" class="card section">
        <h2>Configuraci√≥n del asistente</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Aqu√≠ puedes gestionar los <strong>prompts</strong> del asistente: crear nuevos, editarlos,
          eliminarlos y elegir cu√°l estar√° activo.
          </p>
          
          <!-- Crear nuevo prompt -->
          <div style="margin-top:1rem; padding:1rem; border-radius:0.75rem; background:rgba(15,23,42,0.8);">
            <h3 style="margin-top:0; font-size:1rem;">Crear nuevo prompt</h3>
          
            <form method="post" action="{{ url_for('create_prompt') }}">
              <div style="margin-bottom:0.5rem;">
                <label style="display:block; font-size:0.85rem; color:#94a3b8; margin-bottom:0.2rem;">
                  Nombre del prompt
                </label>
                <input type="text" name="nombre" required
                  style="width:100%; padding:0.45rem 0.6rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.9rem;">
              </div>
          
              <div style="margin-bottom:0.5rem;">
                <label style="display:block; font-size:0.85rem; color:#94a3b8; margin-bottom:0.2rem;">
                  Contenido del prompt
                </label>
                <textarea name="contenido" rows="7" required
                  style="width:100%; padding:0.6rem 0.7rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.9rem; resize:vertical;"></textarea>
              </div>
          
              <label style="font-size:0.85rem; color:#94a3b8;">
                <input type="checkbox" name="activar" style="margin-right:0.3rem;">
                Establecer como prompt activo
              </label>
          
              <div style="margin-top:0.7rem;">
                <button type="submit" class="btn-primary">
                  Guardar prompt
                </button>
              </div>
            </form>
          </div>
          
          <!-- Lista de prompts existentes -->
          <h3 style="margin-top:1.4rem; font-size:1rem;">Prompts configurados</h3>
          
          {% if prompts %}
          <div style="margin-top:0.5rem; max-height:360px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
              <thead>
                <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Nombre</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem; width:45%;">Contenido</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Estado</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for pr in prompts %}
                <tr style="border-bottom:1px solid rgba(30,41,59,0.6); vertical-align:top;">
                  <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                    {{ pr.nombre }}
                    <div style="font-size:0.75rem; color:#64748b;">
                      {{ pr.created_at }}
                    </div>
                  </td>
                  <td style="padding:0.35rem 0.3rem; color:#cbd5f5; font-size:0.85rem; white-space:pre-wrap;">
                    {{ pr.contenido[:260] }}{% if pr.contenido|length > 260 %}...{% endif %}
                  </td>
                  <td style="padding:0.35rem 0.3rem;">
                    {% if pr.is_active %}
                    <span
                      style="font-size:0.8rem; padding:0.15rem 0.55rem; border-radius:999px; background:rgba(34,197,94,0.15); color:#4ade80;">
                      Activo
                    </span>
                    {% else %}
                    <span
                      style="font-size:0.8rem; padding:0.15rem 0.55rem; border-radius:999px; background:rgba(148,163,184,0.15); color:#94a3b8;">
                      Inactivo
                    </span>
                    {% endif %}
                  </td>
                  <td style="padding:0.35rem 0.3rem;">
                    <!-- Activar -->
                    {% if not pr.is_active %}
                    <form method="post" action="{{ url_for('activate_prompt', prompt_id=pr.id) }}" style="display:inline;">
                      <button type="submit" class="btn-secondary" style="margin-bottom:0.3rem;">
                        Usar este
                      </button>
                    </form>
                    {% endif %}
          
                    <!-- Editar (form inline) -->
                    <details style="margin-top:0.2rem;">
                      <summary style="cursor:pointer; font-size:0.8rem; color:#a5b4fc;">Editar</summary>
                      <div style="margin-top:0.4rem;">
                        <form method="post" action="{{ url_for('update_prompt', prompt_id=pr.id) }}">
                          <input type="text" name="nombre" value="{{ pr.nombre }}" required
                            style="width:100%; padding:0.35rem 0.5rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.85rem; margin-bottom:0.35rem;">
                          <textarea name="contenido" rows="5" required
                            style="width:100%; padding:0.45rem 0.6rem; border-radius:0.5rem; border:1px solid rgba(148,163,184,0.4); background:#020617; color:#e5e7eb; font-size:0.85rem; resize:vertical;">{{ pr.contenido }}</textarea>
                          <div style="margin-top:0.4rem;">
                            <button type="submit" class="btn-primary" style="font-size:0.8rem;">
                              Guardar cambios
                            </button>
                          </div>
                        </form>
                      </div>
                    </details>
          
                    <!-- Eliminar -->
                    <form method="post" action="{{ url_for('delete_prompt', prompt_id=pr.id) }}" class="form-delete-prompt"
                      style="display:inline-block; margin-top:0.3rem;">
                      <button type="submit"
                        style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; border-radius:0.4rem; padding:0.2rem 0.6rem; font-size:0.8rem; cursor:pointer;">
                        Eliminar
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p style="margin-top:0.8rem; color:#94a3b8; font-size:0.9rem;">
            A√∫n no tienes prompts definidos. Crea uno nuevo en el formulario superior.
          </p>
          {% endif %}
          </section>
          <!-- ASISTENTE DE VOZ -->
          <section id="section-voice" class="card section">
            <div class="voice-card-header">
              <div class="voice-avatar">
                <span>‚ö°</span>
              </div>
              <div class="voice-header-text">
                <h2>UNL Asiste</h2>
                <p><span class="status-dot"></span> Conectado y listo para ayudarte</p>
              </div>
              <div class="voice-header-actions">
                <button class="icon-btn" title="Marcar como favorito">‚≠ê</button>
                <button class="icon-btn" title="Ver detalles">üí¨</button>
              </div>
            </div>
          
            <div class="voice-body">
              <div id="chatMessages" class="chat-messages">
                <!-- Mensaje inicial del asistente -->
                <div class="msg msg-bot">
                  <div class="msg-avatar">ü§ñ</div>
                  <div class="msg-bubble">
                    <p>¬°Hola! üëã Soy tu asistente acad√©mico. ¬øEn qu√© puedo ayudarte hoy?</p>
                  </div>
                </div>
              </div>
          
              <div class="chat-input-area">
                <div class="chat-hint">Presiona Enter para enviar</div>
                <div class="chat-input-row">
                  <input id="chatInput" type="text" placeholder="Escribe tu mensaje aqu√≠..." autocomplete="off" />
                  <button id="chatSendBtn" class="chat-send-btn" title="Enviar">
                    ‚û§
                  </button>
                </div>
              </div>
            </div>
          </section>
          
        <!-- GESTI√ìN DE USUARIOS (solo visible para admin) -->
      <section id="section-users" class="card section">
        <h2>Gesti√≥n de usuarios</h2>
        <p style="margin-top:0.4rem; color:#94a3b8; font-size:0.85rem;">
          Aqu√≠ puedes aprobar o rechazar las cuentas nuevas registradas en el sistema.
        </p>

        {% if pending_users %}
          <div style="margin-top:1rem; max-height:420px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
              <thead>
                <tr style="border-bottom:1px solid rgba(148,163,184,0.35);">
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Usuario</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Email</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem; white-space:nowrap;">Fecha registro</th>
                  <th style="text-align:left; padding:0.4rem 0.3rem;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for u in pending_users %}
                  <tr style="border-bottom:1px solid rgba(30,41,59,0.6);">
                    <td style="padding:0.35rem 0.3rem; color:#e2e8f0;">
                      {{ u.username }}
                    </td>
                    <td style="padding:0.35rem 0.3rem; color:#cbd5f5;">
                      {{ u.email }}
                    </td>
                    <td style="padding:0.35rem 0.3rem; color:#94a3b8; font-size:0.8rem; white-space:nowrap;">
                      {{ u.created_at }}
                    </td>
                    <td style="padding:0.35rem 0.3rem;">
                      <!-- Aceptar -->
                      <form method="post"
                            action="{{ url_for('approve_user', user_id=u.id) }}"
                            style="display:inline-block; margin-right:0.3rem;">
                        <button type="submit"
                                style="background:#22c55e; color:#022c22; border:none; border-radius:0.4rem; padding:0.25rem 0.7rem; font-size:0.8rem; cursor:pointer;">
                          Aceptar
                        </button>
                      </form>

                      <!-- Rechazar -->
                      <form method="post"
                            action="{{ url_for('reject_user', user_id=u.id) }}"
                            class="form-reject-user"
                            style="display:inline-block;">
                        <button type="submit"
                                style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; border-radius:0.4rem; padding:0.25rem 0.7rem; font-size:0.8rem; cursor:pointer;">
                          Rechazar
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty">
            <div class="empty-icon">üë•</div>
            <p>No hay usuarios pendientes por aprobar.</p>
            <p class="muted">Los nuevos registros aparecer√°n aqu√≠ para que los revises.</p>
          </div>
        {% endif %}
      </section>

    </main>
  </div>
  <div id="toast" class="toast"></div>
  <script>
    // ====== NAV LATERAL (cambiar secciones) ======
    const sidebarItems = document.querySelectorAll('.sidebar-item:not(.disabled)');
    const sections = document.querySelectorAll('.section');

    sidebarItems.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-section');
        if (!target) return;

        // marcar activo en men√∫
        sidebarItems.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // mostrar secci√≥n correspondiente
        sections.forEach(sec => {
          if (sec.id === 'section-' + target) {
            sec.style.display = 'block';
          } else {
            sec.style.display = 'none';
          }
        });
      });
    });

    // mostrar solo la secci√≥n marcada con .active al inicio
    sections.forEach(sec => {
      if (sec.classList.contains('active')) {
        sec.style.display = 'block';
      } else {
        sec.style.display = 'none';
      }
    });

    // ====== TU L√ìGICA DE SUBIDA / ELIMINACI√ìN ======
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const btnSelect = document.getElementById('btnSelect');
    const btnRebuild = document.getElementById('btnRebuild'); // por si lo usas
    const fileList = document.getElementById('fileList');     // <ul id="fileList">...</ul>

    if (btnSelect && fileInput) {
      btnSelect.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          uploadFile(e.target.files[0]);
        }
      });
    }

    if (dropzone) {
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) uploadFile(file);
      });
    }

    function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      fetch('/upload', {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            addFileToList(data.filename);
          } else {
            alert(data.msg || 'Error al subir');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error de red');
        });
    }

    // conectar botones eliminar ya existentes
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', handleDelete);
    });

    function handleDelete(e) {
      const btn = e.target;
      const name = btn.dataset.name;
      if (!confirm('¬øEliminar "' + name + '"?')) return;

      fetch('/delete/' + encodeURIComponent(name), {
        method: 'DELETE'
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            const li = btn.closest('li');
            li.style.transition = "opacity 0.25s ease, transform 0.25s ease";
            li.style.opacity = "0";
            li.style.transform = "translateX(-6px)";
            setTimeout(() => li.remove(), 250);
          } else {
            alert(data.msg || 'No se pudo eliminar');
          }
        });
    }

    function addFileToList(filename) {
      if (!fileList) return;

      const li = document.createElement('li');
      li.dataset.name = filename;
      li.innerHTML = `
        <span class="file-icon">üìÑ</span>
        <a href="/files/${encodeURIComponent(filename)}" target="_blank">${filename}</a>
        <button class="btn-delete" data-name="${filename}">Eliminar</button>
      `;

      fileList.appendChild(li);

      li.style.opacity = "0";
      li.style.transform = "translateY(-4px)";
      setTimeout(() => {
        li.style.transition = "opacity 0.25s ease, transform 0.25s ease";
        li.style.opacity = "1";
        li.style.transform = "translateY(0)";
      }, 30);

      li.querySelector('.btn-delete').addEventListener('click', handleDelete);
    }

    if (btnRebuild) {
      btnRebuild.addEventListener('click', () => {
        fetch('/rebuild', { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.ok) alert('Reprocesado correctamente.');
          });
      });
    }


    // Confirmar eliminaci√≥n de prompt
    document.querySelectorAll('.form-delete-prompt').forEach(form => {
      form.addEventListener('submit', (e) => {
        if (!confirm('¬øSeguro que deseas eliminar este prompt?')) {
          e.preventDefault();
        }
      });
    });

  // Confirmar rechazo de usuario
    document.querySelectorAll('.form-reject-user').forEach(form => {
      form.addEventListener('submit', (e) => {
        if (!confirm('¬øSeguro que deseas rechazar / eliminar esta cuenta?')) {
          e.preventDefault();
        }
      });
    });

    function showToast(message, type = "ok") {
      if (!toast) return;
      toast.textContent = message;
      toast.className = "toast " + type + " show";
      setTimeout(() => {
        toast.classList.remove("show");
      }, 2500);
    }
    // ====== CHAT ASISTENTE DE VOZ (usa /rag) ======
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatMessages = document.getElementById('chatMessages');

    function appendMessage(text, from = 'user') {
      const msg = document.createElement('div');
      msg.classList.add('msg');
      msg.classList.add(from === 'user' ? 'msg-user' : 'msg-bot');

      const avatar = document.createElement('div');
      avatar.classList.add('msg-avatar');
      avatar.textContent = from === 'user' ? 'üôã‚Äç‚ôÇÔ∏è' : 'ü§ñ';

      const bubble = document.createElement('div');
      bubble.classList.add('msg-bubble');
      bubble.innerHTML = `<p>${text}</p>`;

      msg.appendChild(avatar);
      msg.appendChild(bubble);

      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendTyping() {
      const msg = document.createElement('div');
      msg.classList.add('msg', 'msg-bot');
      msg.id = 'typing-indicator';

      const avatar = document.createElement('div');
      avatar.classList.add('msg-avatar');
      avatar.textContent = 'ü§ñ';

      const bubble = document.createElement('div');
      bubble.classList.add('msg-bubble');
      bubble.innerHTML = `
        <div class="typing-dots">
          <span></span><span></span><span></span>
        </div>
      `;

      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTyping() {
      const t = document.getElementById('typing-indicator');
      if (t) t.remove();
    }

    async function sendMessage() {
      const text = (chatInput.value || '').trim();
      if (!text) return;

      appendMessage(text, 'user');
      chatInput.value = '';

      appendTyping();

      try {
        const resp = await fetch('/rag', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pregunta: text })
        });

        const data = await resp.json();
        removeTyping();

        if (data.respuesta) {
          appendMessage(data.respuesta, 'bot');
        } else if (data.error) {
          appendMessage('Ocurri√≥ un error: ' + data.error, 'bot');
        } else {
          appendMessage('No se recibi√≥ respuesta del servidor.', 'bot');
        }
      } catch (err) {
        console.error(err);
        removeTyping();
        appendMessage('Error de red al contactar con el servidor.', 'bot');
      }
    }

    if (chatSendBtn && chatInput) {
      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

  </script>
</body>

</html>